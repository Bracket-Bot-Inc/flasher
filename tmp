# make bracketbot the only user
deluser --remove-home dietpi
rm -rf /home/dietpi

adduser --disabled-password --gecos "" bracketbot
echo "bracketbot:1234" | chpasswd

usermod -aG sudo bracketbot
SUDOERS_FILE="/etc/sudoers.d/bracketbot"
echo "bracketbot ALL=(ALL) NOPASSWD:ALL" > "$SUDOERS_FILE"
chmod 0440 "$SUDOERS_FILE"

# install bracketbot
runasuser() {
       su - bracketbot -c "cd /home/bracketbot; source ~/.bashrc; $*"
}
runasuser "curl -LsSf https://astral.sh/uv/install.sh | sh"
runasuser "uv python install 3.11"
runasuser "git clone -b ipc https://oauth2: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@github.com/Bracket-Bot-Inc/BracketBotOS.git"
runasuser "cd BracketBotOS; uv run ./install"

# allows daemons python to set process priority
runasuser "sudo setcap 'cap_sys_nice=eip' \$(nix-build 'https://github.com/NixOS/nixpkgs/archive/63dacb46bf939521bdc93981b4cbb7ecb58427a0.tar.gz' -A python311 --no-out-link)/bin/python3.11"

# disable spammy kernel logs
echo 'dmesg -n 1' >> /etc/rc.local

# Use NetworkManager instead of ifupdown
sudo apt purge -y ifupdown isc-dhcp-client isc-dhcp-server

sudo systemctl disable --now \
       ifupdown-pre.service \
       dnsmasq.service \
       ifup@wlan0.service ifup@eth0.service \
       dietpi-wifi-monitor.service || true
sudo systemctl mask networking.service ifupdown-pre.service
printf "auto lo\niface lo inet loopback\n" | sudo tee /etc/network/interfaces

# disable mac randomization
sudo tee /etc/NetworkManager/conf.d/90-disable-mac-rand.conf >/dev/null <<'EOF'
[device]
wifi.scan-rand-mac-address=no

[connection]
wifi.cloned-mac-address=permanent
EOF
sudo systemctl restart NetworkManager

# add bracketbot to dialout, audio and video groups
sudo usermod -aG dialout bracketbot
sudo usermod -aG video bracketbot
sudo usermod -aG audio bracketbot

# led strip spi
sudo groupadd spi
sudo usermod -aG spi bracketbot
echo 'SUBSYSTEM=="spidev", GROUP="spi", MODE="0660"' | sudo tee /etc/udev/rules.d/90-spi.rules